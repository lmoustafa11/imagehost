<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOW Training Reports Portal | RadNet CCC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f1729 0%, #1e3a5f 50%, #2c5282 100%);
            color: #333;
            min-height: 100vh;
            padding: 15px; /* Reduced from 20px */
        }

        .portal-container {
            max-width: 1600px;
            margin: 0 auto;
            display: block !important;
        }

        .header {
            background: white;
            border-radius: 12px; /* Slightly tighter corners */
            padding: 20px 30px; /* Reduced padding */
            margin-bottom: 16px; /* Reduced from 24px */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 240px; /* Slightly smaller logo */
            height: auto;
        }

        .header-title {
            border-left: 4px solid #1e3a5f;
            padding-left: 20px;
        }

        .header-title h1 {
            font-size: 2.2rem; /* Adjusted for tighter feel */
            color: #1e3a5f;
            margin-bottom: 2px;
            font-weight: 900;
        }

        .header-title p {
            font-size: 1rem;
            color: #666;
        }

        .stat-pill {
            background: linear-gradient(135deg, #1e3a5f, #2c5282);
            color: white;
            padding: 12px 20px; /* Reduced padding */
            border-radius: 40px;
            text-align: center;
            min-width: 130px;
        }

        .stat-pill .number {
            font-size: 1.8rem;
            font-weight: 900;
            display: block;
            line-height: 1;
        }

        .stat-pill .label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 3px;
            display: block;
        }

        .search-filter-section {
            background: white;
            border-radius: 12px;
            padding: 20px 30px; /* Reduced padding */
            margin-bottom: 16px; /* Reduced from 24px */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* Reduced from 25px */
        }

        .search-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e3a5f;
        }

        .results-count {
            font-size: 0.9rem;
            color: #666;
            background: #f0f4f8;
            padding: 6px 14px;
            border-radius: 20px;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px; /* Reduced */
        }

        .search-input {
            width: 100%;
            padding: 12px 50px 12px 20px; /* Thinner search bar */
            font-size: 0.95rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 18px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px; /* Reduced gap */
        }

        .filter-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .filter-select {
            width: 100%;
            padding: 8px 12px; /* Thinner selects */
            font-size: 0.9rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .clear-filters-btn {
            margin-top: 15px;
            padding: 8px 18px;
            background: #f0f4f8;
            border: none;
            border-radius: 8px;
            color: #1e3a5f;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: #e0e7ef;
        }

        .reports-container {
            display: grid;
            gap: 12px; /* Reduced from 16px */
            min-height: 100px;
        }

        .report-card {
            background: white;
            border-radius: 10px;
            padding: 16px 24px; /* Reduced vertical padding */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 8px solid #1e3a5f;
        }

        .report-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* Vibrant Service Level Bar Colors */
        .service-foundations { border-left-color: #10b981 !important; }
        .service-core2 { border-left-color: #3b82f6 !important; }
        .service-breasthealth { border-left-color: #ec4899 !important; }
        .service-core1 { border-left-color: #f59e0b !important; }
        .service-nesting { border-left-color: #f97316 !important; }

        /* LOCKED: HORIZONTAL SUMMARY LAYOUT */
        .report-summary {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            width: 100%;
            text-align: left;
        }

        .report-field {
            flex: 1;
            min-width: 0;
            text-align: left;
            display: flex;
            flex-direction: column;
        }

        .report-field:first-child {
            flex: 1.5;
        }

        .report-field-label {
            display: block;
            font-size: 0.7rem; /* Slightly smaller label */
            color: #999;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .report-field-value {
            display: block;
            font-size: 0.95rem; /* Slightly smaller value */
            color: #333;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .expand-icon {
            flex: 0 0 30px;
            font-size: 20px;
            color: #1e3a5f;
            transition: transform 0.3s ease;
            text-align: right;
        }

        .report-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .report-details {
            display: none;
            margin-top: 16px; /* Reduced */
            padding-top: 16px; /* Reduced */
            border-top: 1px solid #f0f0f0;
            animation: slideDown 0.3s ease-out;
            text-align: left;
        }

        .report-card.expanded .report-details {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 15px; /* Reduced gap */
            text-align: left;
        }

        /* VERTICAL DETAIL ITEM LAYOUT */
        .detail-item {
            background: #f8f9fa;
            padding: 12px 16px; /* Reduced padding */
            border-radius: 8px;
            border: 1px solid #eee;
            transition: all 0.2s ease;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .status-meets { border-left: 6px solid #10b981 !important; background: #f0fdf4; }
        .status-improvement { border-left: 6px solid #f59e0b !important; background: #fffbeb; }
        .status-notmeets { border-left: 6px solid #ef4444 !important; background: #fef2f2; }

        .detail-label {
            font-size: 0.9rem; /* Reduced from 1rem */
            color: #1e3a5f;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 4px;
            text-align: left;
            width: 100%;
        }

        .detail-text {
            font-size: 0.9rem;
            color: #333;
            line-height: 1.5;
            white-space: pre-wrap;
            text-align: left;
            width: 100%;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.1rem;
        }

        @media (max-width: 900px) {
            .report-summary { flex-direction: column; align-items: flex-start; gap: 10px; }
            .expand-icon { position: absolute; right: 20px; top: 25px; }
        }

        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; }
            .filters-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="portal-container">
        <div class="header">
            <div class="header-left">
                <img src="https://github.com/lmoustafa11/imagehost/blob/main/Radnet%20logo%20hi-rescropped.png?raw=true" alt="RadNet CCC" class="logo">
                <div class="header-title">
                    <h1>EOW Manager Portal</h1>
                    <p>Training & Support Scheduler Insights</p>
                </div>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <div class="stat-pill">
                    <span class="number" id="totalReportsHeader">0</span>
                    <span class="label">Reports</span>
                </div>
                <div class="stat-pill" style="background: linear-gradient(135deg, #10b981, #34d399); cursor: pointer; min-width: 100px;" onclick="manualSync()">
                    <span class="number" style="font-size: 1.8rem;">üîÑ</span>
                    <span class="label">Sync Now</span>
                </div>
            </div>
        </div>

        <div class="search-filter-section">
            <div class="search-header">
                <div>
                    <h2 class="search-title">üîç Find Reports</h2>
                    <div id="lastSyncTime" style="font-size: 0.75rem; color: #999; margin-top: 2px;">Connecting to Smartsheet...</div>
                </div>
                <div class="results-count" id="resultsCount">Loading...</div>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by Agent, Trainer, Managers, or keyword...">
                <span class="search-icon">üîç</span>
            </div>

            <div class="filters-grid">
                <div class="filter-group">
                    <label>Agent Name</label>
                    <select class="filter-select" id="filterAgent">
                        <option value="">All Agents</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Trainer/Support Scheduler</label>
                    <select class="filter-select" id="filterTrainer">
                        <option value="">All Trainers</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Service Level</label>
                    <select class="filter-select" id="filterServiceLevel">
                        <option value="">All Levels</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Manager (Search by Email)</label>
                    <select class="filter-select" id="filterManagerEmail">
                        <option value="">All Manager Emails</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>2nd Lvl Manager</label>
                    <select class="filter-select" id="filterManager2">
                        <option value="">All 2nd Lvl</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>3rd Lvl Manager</label>
                    <select class="filter-select" id="filterManager3">
                        <option value="">All 3rd Lvl</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select class="filter-select" id="sortBy">
                        <option value="created-desc">Created (Newest First)</option>
                        <option value="created-asc">Created (Oldest First)</option>
                        <option value="agent">Agent Name</option>
                    </select>
                </div>
            </div>
            <button class="clear-filters-btn" id="clearFilters">Reset All Filters</button>
        </div>

        <div class="reports-container" id="reportsContainer">
            <div class="loading">Fetching records from Smartsheet...</div>
        </div>
    </div>

    <script>
        const EMBEDDED_TOKEN = 'HfG7wj4gWeUTwyj4H0nFUvoWvnLHOsuYDD1Kz';
        const EMBEDDED_SHEET_ID = '5779855099514756';

        let db = [];
        let filteredReports = [];

        function formatCreatedDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                return date.toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                }).replace(',', '');
            } catch (e) {
                return dateStr;
            }
        }

        function formatName(name) {
            if (!name || typeof name !== 'string') return 'N/A';
            let clean = name.replace(/"/g, '').trim();
            if (!clean) return 'N/A';
            const cap = (s) => {
                const t = s.trim();
                if (!t) return '';
                if (t.length === 1) return t.toUpperCase();
                return t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
            };
            if (clean.includes(',')) {
                const parts = clean.split(',');
                const last = parts[0].trim();
                const firstSect = parts[1].trim(); 
                const firstParts = firstSect.split(' ').filter(Boolean).map(cap);
                return `${firstParts.join(' ')} ${cap(last)}`;
            } else if (clean.includes(' ')) {
                return clean.split(' ').filter(Boolean).map(cap).join(' ');
            }
            return cap(clean);
        }

        async function syncWithSmartsheet() {
            if (!EMBEDDED_TOKEN || !EMBEDDED_SHEET_ID) return;
            const ts = new Date().getTime();
            let url = `https://corsproxy.io/?` + encodeURIComponent(`https://api.smartsheet.com/2.0/sheets/${EMBEDDED_SHEET_ID}?_=${ts}`);

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${EMBEDDED_TOKEN}`, 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error(`API Error (${response.status})`);
                const data = await response.json();
                const colMap = {};
                data.columns.forEach(c => colMap[c.id] = c.title);
                db = data.rows.map(r => {
                    const obj = {};
                    r.cells.forEach(cell => {
                        const colName = colMap[cell.columnId];
                        if (colName) {
                            let val = cell.displayValue || cell.value || '';
                            if (typeof val === 'string') val = val.replace(/"/g, '').trim();
                            obj[colName] = val;
                        }
                    });
                    return obj;
                });
                db.sort((a, b) => new Date(b.Created) - new Date(a.Created));
                localStorage.setItem('eow_manager_data_v2', JSON.stringify(db));
                updateSyncTimestamp('Last synced: ' + new Date().toLocaleTimeString());
                filteredReports = [...db];
                initPortal();
            } catch (err) {
                console.error("‚ùå Sync Error:", err);
                const cached = localStorage.getItem('eow_manager_data_v2');
                if (cached) {
                    db = JSON.parse(cached);
                    updateSyncTimestamp('Offline Mode (Cached Data)');
                } else {
                    updateSyncTimestamp('Sync Failed');
                }
                filteredReports = [...db];
                initPortal();
            }
        }

        function updateSyncTimestamp(msg) {
            const el = document.getElementById('lastSyncTime');
            if (el) el.textContent = msg;
        }

        function manualSync() {
            const container = document.getElementById('reportsContainer');
            if (container) container.innerHTML = '<div class="loading">Refreshing data...</div>';
            syncWithSmartsheet();
        }

        function initPortal() {
            populateFilterOptions();
            renderReports();
            setupEventListeners();
        }

        function populateFilterOptions() {
            const getSet = (col) => [...new Set(db.map(r => formatName(r[col])))].filter(v => v && v !== 'N/A').sort();
            const getRawSet = (col) => [...new Set(db.map(r => r[col]))].filter(v => v && v !== 'N/A').sort();

            populateSelect('filterAgent', getSet('Agent Name'));
            populateSelect('filterTrainer', getSet('Trainer/Support Scheduler'));
            populateSelect('filterServiceLevel', getRawSet('Service Level'));
            populateSelect('filterManagerEmail', getRawSet('Manager Email')); 
            populateSelect('filterManager2', getSet('2nd Level Manager'));
            populateSelect('filterManager3', getSet('3rd Level Manager'));
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            if (!select) return;
            const current = select.value;
            let label = id.replace('filter', '');
            if (label === 'ManagerEmail') label = 'Manager Emails';
            select.innerHTML = `<option value="">All ${label}</option>`;
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.textContent = opt;
                select.appendChild(el);
            });
            select.value = current;
        }

        function renderReports() {
            const container = document.getElementById('reportsContainer');
            if (!container) return;
            document.getElementById('totalReportsHeader').textContent = db.length;
            if (filteredReports.length === 0) {
                container.innerHTML = `<div style="background:white; padding:40px; border-radius:12px; text-align:center; color:#666;">No reports found matching your filters</div>`;
                return;
            }
            container.innerHTML = filteredReports.map((report, index) => createReportCard(report, index)).join('');
            document.getElementById('resultsCount').textContent = `${filteredReports.length} reports found`;
        }

        function createReportCard(report, index) {
            const prominent = ['Agent Name', 'Created', 'Trainer/Support Scheduler', 'Service Level'];
            const isValid = (val) => {
                if (val === null || val === undefined) return false;
                const s = String(val).trim().toUpperCase();
                return s !== '' && s !== 'N/A' && s !== 'NULL' && s !== 'UNDEFINED';
            };

            const sl = String(report['Service Level'] || '').toUpperCase();
            let serviceClass = '';
            if (sl.includes('FOUNDATIONS')) serviceClass = 'service-foundations';
            else if (sl.includes('CORE 2')) serviceClass = 'service-core2';
            else if (sl.includes('BREAST HEALTH')) serviceClass = 'service-breasthealth';
            else if (sl.includes('CORE 1')) serviceClass = 'service-core1';
            else if (sl.includes('NESTING')) serviceClass = 'service-nesting';

            let detailsHtml = '';
            Object.keys(report).forEach(key => {
                if (!prominent.includes(key) && isValid(report[key])) {
                    const value = String(report[key]);
                    const up = value.toUpperCase();
                    const isLong = value.length > 100;
                    
                    let statusClass = '';
                    if (up.includes('MEETS EXPECTATIONS') && !up.includes('DOES NOT MEET')) statusClass = 'status-meets';
                    else if (up.includes('NEEDS IMPROVEMENT')) statusClass = 'status-improvement';
                    else if (up.includes('DOES NOT MEET EXPECTATIONS')) statusClass = 'status-notmeets';
                    
                    detailsHtml += `
                        <div class="detail-item ${isLong ? 'full-width' : ''} ${statusClass}">
                            <span class="detail-label">${key}</span>
                            <div class="detail-text">${value}</div>
                        </div>
                    `;
                }
            });

            return `
                <div class="report-card ${serviceClass}" data-index="${index}" onclick="toggleReport(${index})">
                    <div class="report-summary">
                        <div class="report-field">
                            <div class="report-field-label">Agent Name</div>
                            <div class="report-field-value">${formatName(report['Agent Name'])}</div>
                        </div>
                        <div class="report-field">
                            <div class="report-field-label">Created Date (ET)</div>
                            <div class="report-field-value">${formatCreatedDate(report['Created'])}</div>
                        </div>
                        <div class="report-field">
                            <div class="report-field-label">Support Scheduler</div>
                            <div class="report-field-value">${formatName(report['Trainer/Support Scheduler'])}</div>
                        </div>
                        <div class="report-field">
                            <div class="report-field-label">Service Level</div>
                            <div class="report-field-value">${report['Service Level'] || 'N/A'}</div>
                        </div>
                        <div class="expand-icon">‚ñº</div>
                    </div>
                    <div class="report-details" onclick="event.stopPropagation()">
                        <div class="details-grid">${detailsHtml}</div>
                    </div>
                </div>
            `;
        }

        function toggleReport(idx) {
            const card = document.querySelector(`[data-index="${idx}"]`);
            if (card) card.classList.toggle('expanded');
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const agent = document.getElementById('filterAgent').value;
            const trainer = document.getElementById('filterTrainer').value;
            const level = document.getElementById('filterServiceLevel').value;
            const mEmail = document.getElementById('filterManagerEmail').value;
            const m2 = document.getElementById('filterManager2').value;
            const m3 = document.getElementById('filterManager3').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredReports = db.filter(r => {
                const fa = formatName(r['Agent Name']);
                const ft = formatName(r['Trainer/Support Scheduler']);
                const fmEmail = r['Manager Email'] || '';
                const fm2 = formatName(r['2nd Level Manager']);
                const fm3 = formatName(r['3rd Level Manager']);
                if (search) {
                    const content = (Object.values(r).join(' ') + fa + ft + fmEmail + fm2 + fm3).toLowerCase();
                    if (!content.includes(search)) return false;
                }
                if (agent && fa !== agent) return false;
                if (trainer && ft !== trainer) return false;
                if (level && String(r['Service Level']) !== level) return false;
                if (mEmail && fmEmail !== mEmail) return false;
                if (m2 && fm2 !== m2) return false;
                if (m3 && fm3 !== m3) return false;
                return true;
            });

            if (sortBy === 'created-desc') filteredReports.sort((a, b) => new Date(b.Created) - new Date(a.Created));
            else if (sortBy === 'created-asc') filteredReports.sort((a, b) => new Date(a.Created) - new Date(b.Created));
            else if (sortBy === 'agent') filteredReports.sort((a, b) => formatName(a['Agent Name']).localeCompare(formatName(b['Agent Name'])));
            renderReports();
        }

        function clearFilters() {
            const filters = ['searchInput', 'filterAgent', 'filterTrainer', 'filterServiceLevel', 'filterManagerEmail', 'filterManager2', 'filterManager3'];
            filters.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('sortBy').value = 'created-desc';
            applyFilters();
        }

        function setupEventListeners() {
            const controls = ['searchInput', 'filterAgent', 'filterTrainer', 'filterServiceLevel', 'filterManagerEmail', 'filterManager2', 'filterManager3', 'sortBy'];
            controls.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', applyFilters);
            });
            const clearBtn = document.getElementById('clearFilters');
            if (clearBtn) clearBtn.addEventListener('click', clearFilters);
        }

        window.onload = function() {
            syncWithSmartsheet();
            setInterval(syncWithSmartsheet, 5 * 60 * 1000);
        };
    </script>
</body>
</html>

