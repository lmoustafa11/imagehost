<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            min-height: 100vh;
            color: #0f172a;
            padding: 20px 40px 40px 40px;
        }

        /* ============================================================
           RADNET BRANDING HEADER (MATCHING TEMPLATE)
           ============================================================ */
        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 0 10px;
        }

        .title-section {
            flex: 1;
        }

        /* Title Styling from Template */
        h1 {
            font-size: 4.5rem !important;
            font-weight: 900 !important;
            color: #ffffff !important;
            line-height: 1 !important;
            margin: 0 !important;
            padding: 0 !important;
            text-transform: uppercase !important;
            letter-spacing: 3px !important;
            text-shadow: 
                -2px -2px 0 #000,  
                2px -2px 0 #000,
                -2px 2px 0 #000,
                2px 2px 0 #000,
                3px 3px 0 #000,
                4px 4px 0 #000 !important;
        }

        /* Logo Styling from Template */
        .logo {
            width: 340px;
            height: auto;
            margin-left: 20px;
        }

        /* --- CONTROLS --- */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            padding: 20px 35px;
            border-radius: 24px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        .month-display {
            font-size: 1.6rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            min-width: 350px;
            text-align: center;
            color: white;
        }

        .nav-btn {
            background: white;
            color: #1e3a5f;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 1.2rem;
        }

        .nav-btn:hover {
            transform: scale(1.1);
            background: #f8fafc;
        }

        .export-btn {
            background: #10b981;
            color: white;
            padding: 14px 28px;
            border-radius: 18px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        /* --- CALENDAR GRID --- */
        .calendar-wrapper {
            max-width: 1800px;
            margin: 0 auto;
        }

        .calendar-container {
            background-color: white;
            border-radius: 3rem; 
            overflow: hidden;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .calendar-header-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .calendar-week-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 110px; 
            position: relative;
            border-bottom: 1px solid #f1f5f9;
            transition: min-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .day-cell {
            border-right: 1px solid #f1f5f9;
            padding: 1.25rem;
            position: relative;
            z-index: 1;
            background-color: white;
        }

        /* Outside month styling */
        .day-cell.other-month {
            background-color: #f1f5f9; 
            color: #cbd5e1;
        }

        .day-number {
            font-size: 1rem;
            font-weight: 900;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            margin-bottom: 8px;
            color: #475569;
        }

        .day-number.today {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.5);
        }

        /* --- BAR VISUALIZATION --- */
        .event-layer {
            position: absolute;
            top: 55px; 
            left: 0;
            right: 0;
            bottom: 15px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 56px; 
            gap: 10px;
            pointer-events: none;
            padding: 0 15px;
            z-index: 10;
        }

        .event-bar {
            border-radius: 12px;
            padding: 8px 18px;
            font-size: 0.85rem; 
            font-weight: 900;
            cursor: pointer;
            pointer-events: auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid transparent;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.06);
        }

        .event-bar:hover {
            transform: translateY(-3px) scale(1.005);
            filter: brightness(0.96);
            box-shadow: 0 15px 25px -5px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* Color Scheme */
        .bar-foundations { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; border-left: 10px solid #22c55e; }
        .bar-breasthealth { background-color: #fce7f3; color: #9d174d; border-color: #fbcfe8; border-left: 10px solid #ec4899; }
        .bar-core2 { background-color: #dbeafe; color: #1e40af; border-color: #bfdbfe; border-left: 10px solid #3b82f6; }
        .bar-core1 { background-color: #fef9c3; color: #854d0e; border-color: #fef08a; border-left: 10px solid #eab308; }
        .bar-default { background-color: #f1f5f9; color: #475569; border-color: #e2e8f0; border-left: 10px solid #94a3b8; }

        /* --- MODALS --- */
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(15px);
        }

        #autoSyncIndicator {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
            background: #ffffff;
            color: #1e3a5f;
            padding: 18px 28px;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 900;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.4);
            align-items: center;
            gap: 15px;
            border: 2px solid #3b82f6;
        }
    </style>
</head>
<body>

    <!-- Loading Indicator -->
    <div id="autoSyncIndicator">
        <i class="fas fa-circle-notch fa-spin text-blue-600 text-2xl"></i>
        <span>CONNECTING TO SMARTSHEET...</span>
    </div>

    <div class="calendar-wrapper">
        <!-- HEADER: Title on Left, Logo on Right -->
        <div class="header">
            <div class="title-section">
                <h1>TRAINING CALENDAR</h1>
            </div>
            <img src="https://github.com/lmoustafa11/imagehost/blob/main/radnetlogo%20transparent%20bluehue-1E315A.png?raw=true" alt="RadNet Customer Contact Center" class="logo">
        </div>

        <!-- Controls Area -->
        <div class="controls-bar">
            <div class="flex items-center gap-4">
                <div onclick="changeMonth(-1)" class="nav-btn"><i class="fas fa-chevron-left"></i></div>
                <div id="currentMonthYear" class="month-display">January 2025</div>
                <div onclick="changeMonth(1)" class="nav-btn"><i class="fas fa-chevron-right"></i></div>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="manualSync()" class="text-white hover:text-blue-200 font-black flex items-center gap-2 px-4 transition-all uppercase tracking-widest text-sm">
                    <i class="fas fa-sync-alt"></i> Refresh Sync
                </button>
                <button onclick="exportToExcelCSV()" class="export-btn">
                    <i class="fas fa-file-excel text-emerald-100"></i> Export to Excel
                </button>
            </div>
        </div>

        <!-- Main Calendar -->
        <div class="calendar-container">
            <div class="calendar-header-grid">
                <div class="py-6 text-center text-[12px] font-black text-slate-400 uppercase tracking-widest">Sunday</div>
                <div class="py-6 text-center text-[12px] font-black text-slate-600 uppercase tracking-widest">Monday</div>
                <div class="py-6 text-center text-[12px] font-black text-slate-600 uppercase tracking-widest">Tuesday</div>
                <div class="py-6 text-center text-[12px] font-black text-slate-600 uppercase tracking-widest">Wednesday</div>
                <div class="py-6 text-center text-[12px] font-black text-slate-600 uppercase tracking-widest">Thursday</div>
                <div class="py-6 text-center text-[12px] font-black text-slate-600 uppercase tracking-widest">Friday</div>
                <div class="py-6 text-center text-[12px] font-black text-slate-400 uppercase tracking-widest">Saturday</div>
            </div>
            <div id="calendarRows"></div>
        </div>
    </div>

    <!-- Full Details Modal -->
    <div id="classModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[4rem] shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-4 pl-12 border-b flex justify-between items-center bg-slate-50">
                <h3 id="modalTitle" class="text-3xl font-black text-slate-800">Class Record</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors mr-4"><i class="fas fa-times text-4xl"></i></button>
            </div>
            <div id="classDetailContent" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 text-lg">
                <!-- Content populated via JS -->
            </div>
            <div class="p-4 pr-12 border-t bg-slate-50 flex justify-end">
                <button type="button" onclick="closeModal()" class="px-12 py-4 bg-slate-900 text-white rounded-[2.5rem] font-black shadow-2xl hover:bg-black transition-all text-lg uppercase tracking-widest">Close Record</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * CREDENTIALS
         */
        const EMBEDDED_TOKEN = 'HfG7wj4gWeUTwyj4H0nFUvoWvnLHOsuYDD1Kz';
        const EMBEDDED_SHEET_ID = '1702937219780484';

        // State
        let currentDate = new Date(); 
        const fieldSchema = ['active', 'class', 'classId', 'trainerName', 'leadingTrainer', 'startDate', 'endDate', 'numActiveUsers', 'completionPct', 'duration', 'pto', 'ptoTime', 'trainerCoveringPto', 'holiday', 'predecessors', 'attendance'];
        let db = JSON.parse(localStorage.getItem('training_v5_data')) || [];

        const getBarColorClass = (name) => {
            const n = (name || '').toLowerCase();
            if (n.includes('foundations')) return 'bar-foundations';
            if (n.includes('breast health')) return 'bar-breasthealth';
            if (n.includes('core 2')) return 'bar-core2';
            if (n.includes('core 1')) return 'bar-core1';
            return 'bar-default';
        };

        function getSafeDate(dateStr, timeSuffix = "T00:00:00") {
            if (!dateStr || dateStr === "undefined" || dateStr === "null") return null;
            try {
                const cleanDate = String(dateStr).split('T')[0];
                const d = new Date(cleanDate + timeSuffix);
                return isNaN(d.getTime()) ? null : d;
            } catch (e) { return null; }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarRows');
            const headerText = document.getElementById('currentMonthYear');
            if (!container) return;
            container.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            headerText.innerText = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate);

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();

            let days = [];
            for (let i = firstDayOfMonth; i > 0; i--) days.push({ day: prevMonthDays - i + 1, month: month - 1, year, other: true });
            for (let i = 1; i <= daysInMonth; i++) days.push({ day: i, month, year, other: false, date: `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}` });
            const remaining = days.length % 7 === 0 ? 0 : 7 - (days.length % 7);
            for (let i = 1; i <= remaining; i++) days.push({ day: i, month: month + 1, year, other: true });

            for (let w = 0; w < days.length; w += 7) {
                const weekDays = days.slice(w, w + 7);
                const weekRow = document.createElement('div');
                weekRow.className = 'calendar-week-row';

                weekDays.forEach(d => {
                    const cell = document.createElement('div');
                    cell.className = `day-cell ${d.other ? 'other-month' : ''}`;
                    const isToday = d.date === new Date().toISOString().split('T')[0];
                    cell.innerHTML = `<div class="day-number ${isToday ? 'today' : ''}">${d.day}</div>`;
                    weekRow.appendChild(cell);
                });

                const overlay = document.createElement('div');
                overlay.className = 'event-layer';

                const weekStart = new Date(year, weekDays[0].month, weekDays[0].day, 0, 0, 0);
                const weekEnd = new Date(year, weekDays[6].month, weekDays[6].day, 23, 59, 59);

                let lanes = [];

                db.forEach(item => {
                    const start = getSafeDate(item.startDate, "T00:00:00");
                    const end = getSafeDate(item.endDate || item.startDate, "T23:59:59");

                    if (start && end && start <= weekEnd && end >= weekStart) {
                        const overlapStart = new Date(Math.max(start, weekStart));
                        const overlapEnd = new Date(Math.min(end, weekEnd));

                        const sDay = overlapStart.getDay();
                        const eDay = overlapEnd.getDay();

                        let vStart = Math.max(sDay, 1); 
                        let vEnd = Math.min(eDay, 5);

                        if (vStart > vEnd || (sDay === 0 && eDay === 0) || (sDay === 6 && eDay === 6)) return;

                        let laneIndex = 0;
                        while (lanes[laneIndex] && lanes[laneIndex].some(range => (vStart <= range.end && vEnd >= range.start))) {
                            laneIndex++;
                        }
                        if (!lanes[laneIndex]) lanes[laneIndex] = [];
                        lanes[laneIndex].push({ start: vStart, end: vEnd });

                        const bar = document.createElement('div');
                        bar.className = `event-bar ${getBarColorClass(item.class)}`;
                        bar.style.gridColumnStart = (vStart + 1).toString();
                        bar.style.gridColumnEnd = (vEnd + 2).toString();
                        bar.style.gridRowStart = (laneIndex + 1).toString();
                        
                        bar.innerHTML = `
                            <div class="truncate leading-tight">${item.class || 'Unnamed'}</div>
                            <div class="text-[10px] opacity-90 flex justify-between mt-2 font-black uppercase tracking-widest">
                                <span class="truncate pr-4">${(item.trainerName || '').split(',')[0]}</span>
                                <span>${item.classId || ''}</span>
                            </div>
                        `;
                        bar.onclick = (e) => { e.stopPropagation(); showDetails(item.id); };
                        overlay.appendChild(bar);
                    }
                });

                // Dynamic height logic (min 1 bar, max 4)
                const laneCount = lanes.length;
                const displayLanes = Math.max(1, Math.min(4, laneCount));
                const dynamicMinHeight = 55 + (displayLanes * 65) + 20; 
                weekRow.style.minHeight = dynamicMinHeight + 'px';

                weekRow.appendChild(overlay);
                container.appendChild(weekRow);
            }
        }

        async function syncWithSmartsheet() {
            const indicator = document.getElementById('autoSyncIndicator');
            if (!EMBEDDED_TOKEN || !EMBEDDED_SHEET_ID) return;

            indicator.style.display = 'flex';
            const timestamp = new Date().getTime();
            let url = `https://corsproxy.io/?` + encodeURIComponent(`https://api.smartsheet.com/2.0/sheets/${EMBEDDED_SHEET_ID}?_=${timestamp}`);

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${EMBEDDED_TOKEN}`, 'Accept': 'application/json' }
                });

                if (!response.ok) throw new Error(`API Error (${response.status})`);

                const data = await response.json();
                const colMap = {};
                data.columns.forEach(c => {
                    const key = (c.title || '').toLowerCase().replace(/[^a-z]/g, '');
                    colMap[c.id] = key;
                });

                const rows = data.rows.map(r => {
                    const obj = { id: r.id.toString() };
                    r.cells.forEach(cell => {
                        const k = colMap[cell.columnId];
                        if (k === 'active') obj.active = cell.displayValue;
                        if (k === 'class') obj.class = cell.displayValue;
                        if (k === 'classid') obj.classId = cell.displayValue;
                        if (k === 'trainername') obj.trainerName = cell.displayValue;
                        if (k === 'leadingtrainer') obj.leadingTrainer = cell.displayValue;
                        if (k === 'startdate') obj.startDate = cell.value || cell.displayValue;
                        if (k === 'enddate') obj.endDate = cell.value || cell.displayValue;
                        if (k === 'duration') obj.duration = cell.displayValue;
                        if (k === 'pto') obj.pto = (cell.value === true) ? "True" : "False";
                        if (k === 'ptotime') obj.ptoTime = cell.displayValue;
                        if (k === 'trainercoveringpto') obj.trainerCoveringPto = cell.displayValue;
                        if (k === 'holiday') obj.holiday = cell.displayValue;
                        if (k === 'predecessors') obj.predecessors = cell.displayValue;
                        if (k === 'attendance') obj.attendance = cell.displayValue;
                        if (k === 'ofactiveusers') obj.numActiveUsers = cell.displayValue;
                        if (k === 'completion') obj.completionPct = cell.displayValue;
                    });
                    return obj;
                });

                const valid = rows.filter(r => r.class && r.startDate);
                if (valid.length > 0) {
                    db = valid;
                    localStorage.setItem('training_v5_data', JSON.stringify(db));

                    renderCalendar();
                }
            } catch (err) {
                console.error("Auto-Sync Failed:", err);
            } finally {
                setTimeout(() => { indicator.style.display = 'none'; }, 1000);
            }
        }

        function manualSync() { syncWithSmartsheet(); }
        function closeModal() { document.getElementById('classModal').classList.add('hidden'); }

        function showDetails(id) {
            const item = db.find(i => i.id === id);
            if (!item) return;

            const content = document.getElementById('classDetailContent');
            const s = getSafeDate(item.startDate);
            const e = getSafeDate(item.endDate || item.startDate);
            
            content.innerHTML = `
                <div class="space-y-4">
                    <h4 class="text-[14px] font-black text-blue-600 uppercase tracking-widest text-center">General Identity</h4>
                    <div class="bg-slate-50 p-2.5 rounded-2xl border border-slate-200 shadow-inner">
                        <p class="mb-1 font-bold text-slate-800">Class Name:<br><span class="font-black text-xl">${item.class || 'N/A'}</span></p>
                        <p class="mb-1"><strong>Class ID:</strong> ${item.classId || 'N/A'}</p>
                        <p><strong>Status:</strong> ${item.active || 'N/A'}</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-[14px] font-black text-purple-600 uppercase tracking-widest text-center">Timeline</h4>
                    <div class="bg-slate-50 p-2.5 rounded-2xl border border-slate-200 shadow-inner">
                        <p class="mb-1"><strong>Start:</strong> ${s ? s.toLocaleDateString() : 'N/A'}</p>
                        <p class="mb-1"><strong>End:</strong> ${e ? e.toLocaleDateString() : 'N/A'}</p>
                        <p class="mb-1"><strong>Duration:</strong> ${item.duration || 'N/A'}</p>
                        <p><strong>Holiday Note:</strong> ${item.holiday || 'None'}</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-[14px] font-black text-emerald-600 uppercase tracking-widest text-center">Staffing</h4>
                    <div class="bg-slate-50 p-2.5 rounded-2xl border border-slate-200 shadow-inner">
                        <p class="mb-1"><strong>Trainer:</strong> ${item.trainerName || 'N/A'}</p>
                        <p><strong>Lead Email:</strong><br>${item.leadingTrainer || 'N/A'}</p>
                    </div>
                </div>
                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-5 p-3 bg-blue-50 border-2 border-blue-100 rounded-[3.5rem] mt-4 shadow-lg">
                    <div class="space-y-2 text-center">
                        <h4 class="text-[14px] font-black text-blue-800 uppercase tracking-widest">Data & Analytics</h4>
                        <p class="text-2xl font-black text-slate-900">Active Users: ${item.numActiveUsers || '0'}</p>
                        <p class="text-2xl font-black text-slate-900">Completion: ${item.completionPct || '100%'}</p>
                        <p class="mt-3"><a href="${item.attendance}" target="_blank" class="bg-blue-600 text-white px-8 py-3 rounded-3xl font-black inline-block hover:bg-black transition-all shadow-xl tracking-widest text-sm">OPEN TRACKING SHEET</a></p>
                    </div>
                    <div class="space-y-2 text-center">
                        <h4 class="text-[14px] font-black text-red-600 uppercase tracking-widest">PTO Coverage</h4>
                        <p class="text-xl font-bold text-red-900">Time: ${item.ptoTime || 'None Scheduled'}</p>
                        <p class="text-xl font-bold text-red-900">Covering Trainer: ${item.trainerCoveringPto || 'N/A'}</p>
                    </div>
                </div>
            `;

            document.getElementById('classModal').classList.remove('hidden');
        }

        window.onload = function() {
            syncWithSmartsheet();
            renderCalendar();
        };

        function changeMonth(delta) { 
            currentDate.setMonth(currentDate.getMonth() + delta); 
            renderCalendar(); 
        }

        function exportToExcelCSV() {
            const headers = ["Active", "Class", "Class ID", "Trainer Name", "Leading Trainer", "Start Date", "End Date", "# of Active Users", "Attendance", "Completion %", "Duration", "PTO", "PTO Time", "Trainer Covering PTO", "Holiday", "Predecessors"];
            const rows = db.map(i => headers.map(h => {
                const key = h.toLowerCase().replace(/[^a-z]/g, '');
                let val = i[key] || '';
                if (h === "# of Active Users") val = i.numActiveUsers || '0';
                return `"${String(val).replace(/"/g, '""')}"`;
            }).join(","));
            
            const content = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'Training_Calendar_Export.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>