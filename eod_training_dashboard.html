<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOD Training Dashboard | RadNet CCC</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f1729 0%, #1e3a5f 50%, #2c5282 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 260px;
            height: auto;
        }

        .header-title {
            border-left: 4px solid #1e3a5f;
            padding-left: 20px;
        }

        .header-title h1 {
            font-size: 2.5rem;
            color: #1e3a5f;
            margin-bottom: 5px;
            font-weight: 900;
        }

        .header-title p {
            font-size: 1.1rem;
            color: #666;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .period-selector {
            display: flex;
            background: #f0f4f8;
            padding: 5px;
            border-radius: 12px;
            gap: 5px;
        }

        .period-btn {
            border: none;
            background: transparent;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .period-btn.active {
            background: white;
            color: #1e3a5f;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-stats {
            display: flex;
            gap: 20px;
        }

        .stat-pill {
            background: linear-gradient(135deg, #1e3a5f, #2c5282);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            text-align: center;
            min-width: 140px;
        }

        .stat-pill .number {
            font-size: 2rem;
            font-weight: 900;
            display: block;
            line-height: 1;
        }

        .stat-pill .label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 5px;
            display: block;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #1e3a5f, #2c5282);
        }

        .kpi-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .kpi-value-container {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 900;
            color: #1e3a5f;
            margin-bottom: 5px;
        }

        .trend-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 6px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 5px;
        }

        .trend-up { background: #e8f5e9; color: #10b981; }
        .trend-down { background: #fbe9e7; color: #ef4444; }
        .trend-neutral { background: #f0f4f8; color: #666; }

        .kpi-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
            width: 100%;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .chart-card canvas {
            max-height: 320px;
            width: 100% !important;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e3a5f;
        }

        .chart-subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-top: 4px;
        }

        .trainer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .trainer-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .trainer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .trainer-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .trainer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .trainer-info h3 {
            font-size: 1.1rem;
            color: #1e3a5f;
            margin-bottom: 4px;
        }

        .trainer-info p {
            font-size: 0.85rem;
            color: #666;
        }

        .trainer-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .trainer-metric {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .trainer-metric .value {
            font-size: 1.5rem;
            font-weight: 900;
            color: #1e3a5f;
        }

        .trainer-metric .label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        @media (max-width: 1400px) {
            .kpi-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .header-stats {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }

            .header-controls {
                flex-direction: column;
                width: 100%;
                gap: 15px;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .kpi-card, .chart-card, .trainer-card {
            animation: fadeInUp 0.5s ease-out;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px 30px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-title {
            font-size: 1.6rem;
            font-weight: 900;
            color: #1e3a5f;
        }

        .modal-close {
            background: #f0f4f8;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: #1e3a5f;
        }

        .modal-close:hover {
            background: #e0e7ef;
        }

        .modal-close.back-btn::before {
            content: '‚Üê';
        }

        .modal-close.close-btn::before {
            content: '√ó';
        }

        .modal-body {
            padding: 30px;
        }

        /* Summary Banner for Report Details */
        .report-summary-banner {
            background: #f0f4f8;
            border-radius: 12px;
            padding: 15px 24px;
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-items: center;
            border-left: 5px solid #1e3a5f;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-item label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        .summary-item span {
            font-size: 1rem;
            font-weight: 700;
            color: #1e3a5f;
        }

        /* Override for status badge text in banner */
        .summary-item span.status-badge {
            color: white !important;
        }

        .report-list {
            display: grid;
            gap: 12px;
        }

        .report-list-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #1e3a5f;
        }

        .report-list-item:hover {
            background: #e8f4f8;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .report-list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .report-list-item-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e3a5f;
        }

        .report-list-item-date {
            font-size: 0.9rem;
            color: #666;
        }

        .report-list-item-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: #666;
        }

        .report-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .detail-box {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 10px;
            border-left: 3px solid #1e3a5f;
            display: flex;
            flex-direction: column;
        }

        .detail-box h3 {
            font-size: 0.9rem;
            color: #1e3a5f;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-box-content {
            font-size: 0.9rem;
            color: #333;
            line-height: 1.5;
            white-space: pre-wrap;
            flex-grow: 1;
        }

        .detail-box-content strong {
            color: #1e3a5f;
            display: inline-block;
            min-width: 120px;
        }

        .detail-box.full-width {
            grid-column: 1 / -1;
        }

        .trainer-badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .trainer-badge-item {
            background: #1e3a5f;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            color: white !important; /* Ensure white text regardless of context */
            text-align: center;
            display: inline-block;
        }
        
        .status-on-schedule { background: #10b981; }
        .status-ahead { background: #3b82f6; }
        .status-behind { background: #ef4444; }

        .info-row {
            display: flex;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .recent-reports-section {
            margin-top: 24px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .clickable {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .clickable:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="header-left">
                <img src="https://github.com/lmoustafa11/imagehost/blob/main/Radnet%20logo%20hi-rescropped.png?raw=true" alt="RadNet Customer Contact Center" class="logo">
                <div class="header-title">
                    <h1>Training Dashboard</h1>
                    <p>End-of-Day Performance Analytics</p>
                </div>
            </div>
            
            <div class="header-controls">
                <div class="period-selector">
                    <button class="period-btn" onclick="setPeriod(7)">Last 7D</button>
                    <button class="period-btn active" onclick="setPeriod(30)">Last 30D</button>
                    <button class="period-btn" onclick="setPeriod(0)">All Time</button>
                </div>
                <div class="header-stats">
                    <div class="stat-pill">
                        <span class="number" id="totalReports">0</span>
                        <span class="label">Total Reports</span>
                    </div>
                    <div class="stat-pill">
                        <span class="number" id="activeClasses">0</span>
                        <span class="label">Classes</span>
                    </div>
                    <div class="stat-pill" style="background: linear-gradient(135deg, #10b981, #34d399); cursor: pointer;" onclick="syncWithSmartsheet()" title="Click to sync">
                        <span class="number" style="font-size: 1.5rem;">üîÑ</span>
                        <span class="label">Sync Now</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card clickable" onclick="showOnScheduleDetails()">
                <div class="kpi-icon" style="background: #e3f2fd;">üìä</div>
                <div class="kpi-value-container">
                    <div class="kpi-value" id="onSchedule">0%</div>
                    <div id="onScheduleTrend" class="trend-badge trend-neutral">--</div>
                </div>
                <div class="kpi-label">On Schedule</div>
            </div>

            <div class="kpi-card clickable" onclick="showTrainersList()">
                <div class="kpi-icon" style="background: #f3e5f5;">üë•</div>
                <div class="kpi-value-container">
                    <div class="kpi-value" id="activeTrainers">0</div>
                    <div id="trainersTrend" class="trend-badge trend-neutral">--</div>
                </div>
                <div class="kpi-label">Trainers</div>
            </div>

            <div class="kpi-card clickable" onclick="showEventsDetails()">
                <div class="kpi-icon" style="background: #e8f5e9;">üéØ</div>
                <div class="kpi-value-container">
                    <div class="kpi-value" id="eventsCount">0</div>
                    <div id="eventsTrend" class="trend-badge trend-neutral">--</div>
                </div>
                <div class="kpi-label">Events</div>
            </div>

            <div class="kpi-card clickable" onclick="showTechIssuesDetails()">
                <div class="kpi-icon" style="background: #fff9c4;">‚öôÔ∏è</div>
                <div class="kpi-value-container">
                    <div class="kpi-value" id="techIssuesCount">0</div>
                    <div id="techIssuesTrend" class="trend-badge trend-neutral">--</div>
                </div>
                <div class="kpi-label">Tech Issues</div>
            </div>

            <div class="kpi-card clickable" onclick="showAgentIssuesDetails()">
                <div class="kpi-icon" style="background: #ffe0b2;">‚ö†Ô∏è</div>
                <div class="kpi-value-container">
                    <div class="kpi-value" id="agentIssuesCount">0</div>
                    <div id="agentIssuesTrend" class="trend-badge trend-neutral">--</div>
                </div>
                <div class="kpi-label">Agent Issues</div>
            </div>

            <div class="kpi-card clickable" onclick="showPeriodReports()">
                <div class="kpi-icon" style="background: #fff3e0;">üìÖ</div>
                <div class="kpi-value-container">
                    <div class="kpi-value" id="periodReports">0</div>
                    <div id="periodReportsTrend" class="trend-badge trend-neutral">--</div>
                </div>
                <div class="kpi-label" id="periodReportsLabel">Reports (Period)</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Daily Reports Trend</div>
                        <div class="chart-subtitle" id="trendSubtitle">Selected period</div>
                    </div>
                </div>
                <canvas id="dailyReportsChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Class Progress Status</div>
                        <div class="chart-subtitle">Current status breakdown</div>
                    </div>
                </div>
                <canvas id="progressChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Service Level Distribution</div>
                        <div class="chart-subtitle">Training programs</div>
                    </div>
                </div>
                <canvas id="serviceLevelChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Trainer Workload</div>
                        <div class="chart-subtitle">Reports by trainer</div>
                    </div>
                </div>
                <div style="flex-grow: 1; position: relative;">
                    <canvas id="trainerWorkloadChart"></canvas>
                </div>
            </div>
        </div>

        <div class="chart-card full-width">
            <div class="chart-header">
                <div>
                    <div class="chart-title">Trainer Performance</div>
                    <div class="chart-subtitle">Individual metrics and engagement</div>
                </div>
            </div>
            <div class="trainer-grid" id="trainerGrid">
                <div class="loading">Loading trainer data...</div>
            </div>
        </div>

        <div class="chart-card full-width recent-reports-section">
            <div class="chart-header">
                <div>
                    <div class="chart-title">Recent Reports</div>
                    <div class="chart-subtitle">Latest submissions in period</div>
                </div>
            </div>
            <div class="report-list" id="recentReportsList">
                <div class="loading">Loading recent reports...</div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed views -->
    <div id="detailModal" class="modal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Details</h2>
                <button class="modal-close close-btn" id="modalCloseBtn" onclick="handleModalClose()"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <script>
        const EMBEDDED_TOKEN = 'HfG7wj4gWeUTwyj4H0nFUvoWvnLHOsuYDD1Kz';
        const EMBEDDED_SHEET_ID = '5570408476528516';

        let db = [];
        let filteredDb = [];
        let currentDays = 30;
        let charts = {};
        let navigationStack = [];
        let globalTrainerColorMap = {};

        function getTrainerColor(name) {
            if (!name) return '#1e3a5f';
            const normalized = normalizeTrainerName(name);
            return globalTrainerColorMap[normalized] || '#1e3a5f';
        }

        const MASTER_PALETTE = [
            '#1e3a5f', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
            '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#6366f1',
            '#84cc16', '#d946ef', '#0ea5e9', '#f43f5e', '#22c55e',
            '#fbbf24', '#c084fc', '#2dd4bf', '#fb7185', '#38bdf8'
        ];

        function initializeTrainerColors(allData) {
            const allTrainers = new Set();
            allData.forEach(r => {
                const names = (r.Trainer || '').split('\n').flatMap(t => t.split(',').map(n => normalizeTrainerName(n))).filter(Boolean);
                names.forEach(n => allTrainers.add(n));
            });
            const sortedNames = Array.from(allTrainers).sort();
            globalTrainerColorMap = {};
            sortedNames.forEach((name, index) => {
                if (index < MASTER_PALETTE.length) globalTrainerColorMap[name] = MASTER_PALETTE[index];
                else globalTrainerColorMap[name] = `hsl(${(index * 137.5) % 360}, 60%, 45%)`;
            });
        }

        function hasValue(val) {
            if (!val) return false;
            const str = String(val).trim().toUpperCase();
            return str !== '' && str !== 'N/A';
        }

        function normalizeTrainerName(name) {
            if (!name) return '';
            let trimmed = name.trim();
            const lower = trimmed.toLowerCase();
            if (lower.includes('kezi') && lower.includes('benson')) return "Kezi'a Benson";
            return trimmed;
        }

        async function syncWithSmartsheet() {
            if (!EMBEDDED_TOKEN || !EMBEDDED_SHEET_ID) return;
            const timestamp = new Date().getTime();
            const url = 'https://corsproxy.io/?' + encodeURIComponent(`https://api.smartsheet.com/2.0/sheets/${EMBEDDED_SHEET_ID}?_=${timestamp}`);
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${EMBEDDED_TOKEN}`, 'Accept': 'application/json' } });
                if (!response.ok) throw new Error(`API Error (${response.status})`);
                const data = await response.json();
                const colMap = {};
                data.columns.forEach(c => colMap[c.id] = c.title);
                db = data.rows.map(r => {
                    const obj = {};
                    r.cells.forEach(cell => {
                        const columnName = colMap[cell.columnId];
                        if (columnName) obj[columnName] = cell.displayValue || cell.value || '';
                    });
                    return obj;
                }).filter(report => {
                    if (report['Created date']) {
                        const createdDate = new Date(report['Created date']);
                        return createdDate >= new Date('2025-01-01');
                    }
                    return true;
                });
                initializeTrainerColors(db);
                localStorage.setItem('eod_dashboard_data', JSON.stringify(db));
                setPeriod(currentDays);
            } catch (err) {
                console.error("‚ùå Sync failed:", err);
                const cached = localStorage.getItem('eod_dashboard_data');
                if (cached) {
                    db = JSON.parse(cached);
                    initializeTrainerColors(db);
                    setPeriod(currentDays);
                }
            }
        }

        function setPeriod(days) {
            currentDays = parseInt(days);
            document.querySelectorAll('.period-btn').forEach(btn => {
                const isSelected = (days === 7 && btn.innerText.includes('7D')) || 
                                   (days === 30 && btn.innerText.includes('30D')) || 
                                   (days === 0 && btn.innerText.includes('All'));
                btn.classList.toggle('active', isSelected);
            });
            document.getElementById('periodReportsLabel').innerText = days === 0 ? 'Total Reports' : `Reports (Last ${days}D)`;
            document.getElementById('trendSubtitle').innerText = days === 0 ? 'Full History' : `Last ${days} Days`;
            if (days === 0) filteredDb = [...db];
            else {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                filteredDb = db.filter(r => new Date(r['Created date']) >= cutoff);
            }
            calculateAndRender();
        }

        function calculateMetrics(data) {
            const statusCounts = { 'On Schedule': 0, 'Ahead of Schedule': 0, 'Behind Schedule': 0 };
            const trainersMap = {};
            const serviceLevels = {};
            const daily = {};
            let eventCount = 0, techIssueCount = 0, agentIssueCount = 0;
            data.forEach(r => {
                const status = (r['Heat Map'] || '').toLowerCase();
                if (status.includes('ahead')) statusCounts['Ahead of Schedule']++;
                else if (status.includes('behind')) statusCounts['Behind Schedule']++;
                else if (status.includes('on schedule')) statusCounts['On Schedule']++;
                const tNames = (r.Trainer || '').split('\n').flatMap(t => t.split(',').map(n => normalizeTrainerName(n))).filter(Boolean);
                tNames.forEach(name => {
                    if (!trainersMap[name]) trainersMap[name] = { name, reports: 0, classes: new Set(), onTrack: 0, total: 0 };
                    trainersMap[name].reports++;
                    if (r['Class ID']) trainersMap[name].classes.add(r['Class ID']);
                    trainersMap[name].total++;
                    if (status.includes('on schedule') || status.includes('ahead')) trainersMap[name].onTrack++;
                });
                if (r['Service Level']) serviceLevels[r['Service Level']] = (serviceLevels[r['Service Level']] || 0) + 1;
                if (r['Created date']) {
                    const d = new Date(r['Created date']), dStr = `${d.getMonth() + 1}/${d.getDate()}`;
                    daily[dStr] = (daily[dStr] || 0) + 1;
                }
                if (hasValue(r['Events'])) eventCount++;
                if (hasValue(r['Technical Issues'])) techIssueCount++;
                if (hasValue(r['Agent Issues'])) agentIssueCount++;
            });
            const totalWithStatus = Object.values(statusCounts).reduce((a, b) => a + b, 0);
            return {
                totalReports: data.length,
                classes: [...new Set(data.map(r => r['Class ID']).filter(Boolean))].length,
                onSchedulePercent: totalWithStatus > 0 ? Math.round((statusCounts['On Schedule'] / totalWithStatus) * 100) : 0,
                trainersCount: Object.keys(trainersMap).length,
                eventCount, techIssueCount, agentIssueCount,
                statusCounts, serviceLevels,
                daily: Object.entries(daily).sort((a,b) => new Date(a[0]) - new Date(b[0])),
                trainers: Object.values(trainersMap).map(t => ({
                    ...t,
                    classes: t.classes.size,
                    onSchedule: t.total > 0 ? Math.round((t.onTrack / t.total) * 100) : 0
                })).sort((a, b) => b.reports - a.reports)
            };
        }

        function calculatePreviousPeriodMetrics() {
            if (currentDays === 0) return null;
            const end = new Date();
            end.setDate(end.getDate() - currentDays);
            const start = new Date();
            start.setDate(start.getDate() - (currentDays * 2));
            const prevData = db.filter(r => {
                const d = new Date(r['Created date']);
                return d >= start && d < end;
            });
            return calculateMetrics(prevData);
        }

        function updateDashboardUI(cur, prev) {
            document.getElementById('totalReports').textContent = db.length;
            document.getElementById('activeClasses').textContent = [...new Set(db.map(r => r['Class ID']).filter(Boolean))].length;
            document.getElementById('onSchedule').textContent = cur.onSchedulePercent + '%';
            document.getElementById('activeTrainers').textContent = cur.trainersCount;
            document.getElementById('eventsCount').textContent = cur.eventCount;
            document.getElementById('techIssuesCount').textContent = cur.techIssueCount;
            document.getElementById('agentIssuesCount').textContent = cur.agentIssueCount;
            document.getElementById('periodReports').textContent = cur.totalReports;
            if (prev) {
                const compSuffix = `vs prev ${currentDays}d`;
                renderTrend('onScheduleTrend', cur.onSchedulePercent, prev.onSchedulePercent, compSuffix);
                renderTrend('trainersTrend', cur.trainersCount, prev.trainersCount, compSuffix);
                renderTrend('eventsTrend', cur.eventCount, prev.eventCount, compSuffix, true);
                renderTrend('techIssuesTrend', cur.techIssueCount, prev.techIssueCount, compSuffix, true);
                renderTrend('agentIssuesTrend', cur.agentIssueCount, prev.agentIssueCount, compSuffix, true);
                renderTrend('periodReportsTrend', cur.totalReports, prev.totalReports, compSuffix);
            }
        }

        function renderTrend(id, cur, prev, compText, isNegativeMetric = false) {
            const el = document.getElementById(id);
            if (!el) return;
            if (prev === undefined || prev === null || (prev === 0 && cur === 0)) { el.innerText = '--'; el.className = 'trend-badge trend-neutral'; return; }
            const diff = cur - prev, pct = prev === 0 ? 100 : Math.round((diff / prev) * 100);
            if (pct > 0) { el.className = isNegativeMetric ? 'trend-badge trend-down' : 'trend-badge trend-up'; el.innerText = `‚Üë ${pct}% ${compText}`; }
            else if (pct < 0) { el.className = isNegativeMetric ? 'trend-badge trend-up' : 'trend-badge trend-down'; el.innerText = `‚Üì ${Math.abs(pct)}% ${compText}`; }
            else { el.className = 'trend-badge trend-neutral'; el.innerText = `0% ${compText}`; }
        }

        function calculateAndRender() {
            const metrics = calculateMetrics(filteredDb), prevMetrics = calculatePreviousPeriodMetrics();
            updateDashboardUI(metrics, prevMetrics);
            renderCharts(metrics);
            renderTrainerCards(metrics.trainers);
            renderRecentReports(filteredDb);
        }

        function renderCharts(data) {
            const commonScales = { y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, x: { grid: { display: false } } };
            if (charts.daily) charts.daily.destroy();
            charts.daily = new Chart(document.getElementById('dailyReportsChart').getContext('2d'), {
                type: 'line',
                data: { labels: data.daily.map(d => d[0]), datasets: [{ data: data.daily.map(d => d[1]), borderColor: '#1e3a5f', tension: 0.4, fill: true, backgroundColor: 'rgba(30, 58, 95, 0.05)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: commonScales }
            });
            if (charts.progress) charts.progress.destroy();
            charts.progress = new Chart(document.getElementById('progressChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: Object.keys(data.statusCounts), datasets: [{ data: Object.values(data.statusCounts), backgroundColor: ['#10b981', '#3b82f6', '#ef4444'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
            if (charts.service) charts.service.destroy();
            const serviceLabels = Object.keys(data.serviceLevels);
            const serviceColors = serviceLabels.map(label => {
                const l = label.toLowerCase();
                if (l.includes('core 2') || l.includes('core ii')) return '#60a5fa'; 
                if (l.includes('core 1') || l.includes('core i')) return '#facc15'; 
                if (l.includes('breast health')) return '#ec4899'; 
                if (l.includes('foundations')) return '#10b981'; 
                return '#1e3a5f';
            });
            charts.service = new Chart(document.getElementById('serviceLevelChart').getContext('2d'), {
                type: 'bar',
                data: { labels: serviceLabels, datasets: [{ data: Object.values(data.serviceLevels), backgroundColor: serviceColors, borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: commonScales }
            });
            if (charts.workload) charts.workload.destroy();
            charts.workload = new Chart(document.getElementById('trainerWorkloadChart').getContext('2d'), {
                type: 'bar',
                data: { labels: data.trainers.map(t => t.name.split(' ')[0]), datasets: [{ data: data.trainers.map(t => t.reports), backgroundColor: data.trainers.map(t => getTrainerColor(t.name)), borderRadius: 8 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, y: { grid: { display: false } } } }
            });
        }

        function renderTrainerCards(trainers) {
            const grid = document.getElementById('trainerGrid');
            grid.innerHTML = trainers.length ? trainers.map(t => {
                const safeName = t.name.replace(/'/g, "\\'"), initials = t.name.split(' ').map(n => n[0]).join('').toUpperCase();
                return `
                <div class="trainer-card" onclick="showTrainerDetails('${safeName}')">
                    <div class="trainer-header"><div class="trainer-avatar" style="background: ${getTrainerColor(t.name)}">${initials}</div><div class="trainer-info"><h3>${t.name}</h3><p>${t.classes} Classes</p></div></div>
                    <div class="trainer-metrics"><div class="trainer-metric"><div class="value">${t.reports}</div><div class="label">Reports</div></div><div class="trainer-metric"><div class="value">${t.onSchedule}%</div><div class="label">On Track</div></div></div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${t.onSchedule}%"></div></div>
                </div>`}).join('') : '<div class="loading">No trainer data for period</div>';
        }

        function renderRecentReports(data) {
            const container = document.getElementById('recentReportsList'), recent = [...data].sort((a,b) => new Date(b['Created date']) - new Date(a['Created date'])).slice(0, 10);
            container.innerHTML = recent.length ? recent.map(r => `
                <div class="report-list-item" onclick="showReportDetails(${db.indexOf(r)})">
                    <div class="report-list-item-header"><div class="report-list-item-title">${r['Class ID']} - ${r['Service Level']}</div><div class="report-list-item-date">${r['Created on']}</div></div>
                    <div class="report-list-item-meta"><span>üë§ ${(r.Trainer || '').split('\n')[0]}</span><span class="status-badge ${getStatusClass(r['Heat Map'])}">${r['Heat Map'] || 'N/A'}</span></div>
                </div>`).join('') : '<div class="empty-state">No reports in period</div>';
        }

        function openModal(title, content, showBack = false) {
            navigationStack.push({ title, content });
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modalCloseBtn').className = (navigationStack.length > 1 || showBack) ? 'modal-close back-btn' : 'modal-close close-btn';
            document.getElementById('detailModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function handleModalClose() {
            if (navigationStack.length > 1) {
                navigationStack.pop();
                const prev = navigationStack[navigationStack.length - 1];
                document.getElementById('modalTitle').textContent = prev.title;
                document.getElementById('modalBody').innerHTML = prev.content;
                document.getElementById('modalCloseBtn').className = navigationStack.length > 1 ? 'modal-close back-btn' : 'modal-close close-btn';
            } else closeModal();
        }

        function closeModal() { navigationStack = []; document.getElementById('detailModal').classList.remove('active'); document.body.style.overflow = 'auto'; }
        function closeModalOnBackdrop(e) { if (e.target.id === 'detailModal') closeModal(); }

        function showOnScheduleDetails() {
            const reports = filteredDb.filter(r => (r['Heat Map'] || '').toLowerCase().includes('on schedule'));
            const content = `<div class="report-list">${reports.map(r => `<div class="report-list-item" onclick="showReportDetails(${db.indexOf(r)})"><div>${r['Class ID']} - ${r['Created on']}</div></div>`).join('')}</div>`;
            openModal(`On Schedule (${reports.length})`, content);
        }

        function showTrainersList() {
            const tNames = [...new Set(filteredDb.flatMap(r => (r.Trainer || '').split('\n').flatMap(t => t.split(',').map(n => normalizeTrainerName(n))).filter(Boolean)))].sort();
            const content = `<div class="report-list">${tNames.map(n => `<div class="report-list-item" onclick="showTrainerDetails('${n.replace(/'/g, "\\'")}')"><div>${n}</div></div>`).join('')}</div>`;
            openModal(`Trainers (${tNames.length})`, content);
        }

        function showEventsDetails() {
            const reports = filteredDb.filter(r => hasValue(r['Events']));
            const content = `<div class="report-list">${reports.map(r => `<div class="report-list-item" onclick="showReportDetails(${db.indexOf(r)})"><div><strong>${r['Class ID']}:</strong> ${r['Events']}</div></div>`).join('')}</div>`;
            openModal(`Events Recorded (${reports.length})`, content);
        }

        function showTechIssuesDetails() {
            const reports = filteredDb.filter(r => hasValue(r['Technical Issues']));
            const content = `<div class="report-list">${reports.map(r => `<div class="report-list-item" onclick="showReportDetails(${db.indexOf(r)})"><div><strong>${r['Class ID']}:</strong> ${r['Technical Issues']}</div></div>`).join('')}</div>`;
            openModal(`Tech Issues Recorded (${reports.length})`, content);
        }

        function showAgentIssuesDetails() {
            const reports = filteredDb.filter(r => hasValue(r['Agent Issues']));
            const content = `<div class="report-list">${reports.map(r => `<div class="report-list-item" onclick="showReportDetails(${db.indexOf(r)})"><div><strong>${r['Class ID']}:</strong> ${r['Agent Issues']}</div></div>`).join('')}</div>`;
            openModal(`Agent Issues Recorded (${reports.length})`, content);
        }

        function showPeriodReports() {
            const content = `<div class="report-list">${filteredDb.map(r => `<div class="report-list-item" onclick="showReportDetails(${db.indexOf(r)})"><div>${r['Class ID']} - ${r['Created on']}</div></div>`).join('')}</div>`;
            openModal('Period Reports', content);
        }

        function showTrainerDetails(name) {
            const reports = filteredDb.filter(r => {
                const names = (r.Trainer || '').split('\n').flatMap(t => t.split(',').map(n => normalizeTrainerName(n)));
                return names.includes(name);
            });
            const content = `<div class="report-list">${reports.map(r => `<div class="report-list-item" onclick="showReportDetails(${db.indexOf(r)})"><div>${r['Class ID']} - ${r['Created on']}</div></div>`).join('')}</div>`;
            openModal(`${name} - Reports`, content);
        }

        function showReportDetails(reportIndex) {
            const report = db[reportIndex];
            if (!report) return;

            const trainers = (report.Trainer || '').split('\n').flatMap(t => 
                t.split(',').map(name => normalizeTrainerName(name)).filter(Boolean)
            );

            const status = report['Heat Map'] || 'No status';
            const statusClass = getStatusClass(status);

            let content = `
                <div class="report-summary-banner">
                    <div class="summary-item">
                        <label>Service Level</label>
                        <span>${report['Service Level'] || 'N/A'}</span>
                    </div>
                    <div class="summary-item">
                        <label>Day of Class</label>
                        <span>${report['Day of Class'] || 'N/A'}</span>
                    </div>
                    <div class="summary-item">
                        <label>Date Submitted</label>
                        <span>${report['Created on'] || 'N/A'}</span>
                    </div>
                    <div class="summary-item" style="margin-left: auto;">
                        <label>Current Status</label>
                        <span class="status-badge ${statusClass}" style="padding: 6px 16px; font-size: 0.85rem; color: white !important;">${status}</span>
                    </div>
                </div>

                <div class="report-details-grid">
            `;

            // Unified Instruction row - set to full-width and compact padding to remove dead space
            content += `
                <div class="detail-box full-width" style="padding: 12px 16px;">
                    <h3 style="margin-bottom: 8px;">üë• Instruction Team</h3>
                    <div class="detail-box-content" style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div class="trainer-badge-list">
                            ${trainers.map(t => `<span class="trainer-badge-item" style="background: ${getTrainerColor(t)}">${t}</span>`).join('')}
                        </div>
                        ${hasValue(report['Trainer Coach']) ? `<div class="info-row" style="margin-bottom: 0;"><strong>Coach:</strong> ${report['Trainer Coach']}</div>` : ''}
                    </div>
                </div>
            `;

            if (hasValue(report['Topics Covered'])) content += `<div class="detail-box full-width"><h3>üìö Topics Covered</h3><div class="detail-box-content">${report['Topics Covered']}</div></div>`;
            if (hasValue(report['EOD wrap up'])) content += `<div class="detail-box full-width"><h3>üìù EOD Wrap Up</h3><div class="detail-box-content">${report['EOD wrap up']}</div></div>`;
            if (hasValue(report['Events'])) content += `<div class="detail-box full-width"><h3>üìÖ Notable Events</h3><div class="detail-box-content">${report['Events']}</div></div>`;
            if (hasValue(report['Technical Issues'])) content += `<div class="detail-box full-width"><h3>‚öôÔ∏è Technical Issues</h3><div class="detail-box-content">${report['Technical Issues']}</div></div>`;
            if (hasValue(report['Agent Issues'])) content += `<div class="detail-box full-width"><h3>‚ö†Ô∏è Agent Issues</h3><div class="detail-box-content">${report['Agent Issues']}</div></div>`;
            if (hasValue(report['Follow-Up Actions'])) content += `<div class="detail-box full-width"><h3>üéØ Follow-Up Actions</h3><div class="detail-box-content">${report['Follow-Up Actions']}</div></div>`;

            content += `</div>`;
            openModal(`Report: ${report['Class ID'] || 'Untitled'}`, content, true);
        }

        function getStatusClass(status) {
            if (!status) return 'status-on-schedule';
            const lower = status.toLowerCase();
            if (lower.includes('ahead')) return 'status-ahead';
            if (lower.includes('behind')) return 'status-behind';
            return 'status-on-schedule';
        }

        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { const modal = document.getElementById('detailModal'); if (modal && modal.classList.contains('active')) handleModalClose(); } });
        window.onload = syncWithSmartsheet;
    </script>
</body>
</html>
